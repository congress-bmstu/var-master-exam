name: Build Typst document
on: [push, workflow_dispatch]

permissions:
  contents: write

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    outputs:
      typst: ${{ steps.filter.outputs.typst }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
    - uses: actions/checkout@v6
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          typst:
            - '*.typ'
            - '**/*.typ'
          workflows:
            - '.github/workflows/**'
  build-and-release:
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DOC_NAME: "var"
    runs-on: ubuntu-latest
    needs: paths-filter
    if: ${{ (needs.paths-filter.outputs.typst == 'true') || (needs.paths-filter.outputs.workflows == 'true') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install emoji fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-emojione fonts-noto-color-emoji

          # Verify installation
          fc-list | grep -i emoji || echo "Emoji fonts installed"

          # Update font cache (important!)
          sudo fc-cache -fv

      - name: Typst
        uses: lvignoli/typst-action@main
        with:
          source_file: ${{env.DOC_NAME}}.typ

      - name: Compress PDF with Ghostscript
        run: |
          # Install Ghostscript if not already available
          if ! command -v gs &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y ghostscript
          fi

          # Compress the PDF /screen /ebook /printer /prepress
          gs -sDEVICE=pdfwrite \
             -dCompatibilityLevel=1.5 \
             -dPDFSETTINGS=/ebook \
             -dNOPAUSE \
             -dQUIET \
             -dBATCH \
             -sOutputFile="${{env.DOC_NAME}}_compressed.pdf" \
             "${{env.DOC_NAME}}.pdf"

          # Check if compression was successful
          if [ -f "${{env.DOC_NAME}}_compressed.pdf" ]; then
            # Get file sizes for comparison
            original_size=$(stat -c%s "${{env.DOC_NAME}}.pdf")
            compressed_size=$(stat -c%s "${{env.DOC_NAME}}_compressed.pdf")
            echo "Original: $((original_size/1024))KB"
            echo "Compressed: $((compressed_size/1024))KB"
            echo "Reduction: $((100 - (compressed_size * 100 / original_size)))%"

            # Replace original with compressed version
            mv "${{env.DOC_NAME}}_compressed.pdf" "${{env.DOC_NAME}}.pdf"
          else
            echo "Compression failed, using original PDF"
          fi

      - name: Get current date
        id: date
        run: echo "DATE=$(date +%Y-%m-%d_%H-%M)" >> $GITHUB_ENV

      - name: Upload PDF file
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.DOC_NAME}}-${{env.DATE}}-${{github.sha}}
          path: ${{env.DOC_NAME}}.pdf
          retention-days: 14 # Auto-delete after 14 days

      - name: Release with Notes
        uses: softprops/action-gh-release@v2
        with:
          name: ${{env.DATE}}-${{github.sha}}
          body: Build ${{env.DOC_NAME}}-${{env.DATE}}-${{github.sha}}.pdf
          tag_name: pdf-${{env.DOC_NAME}}-${{env.DATE}}-${{github.sha}}
          files: |
            ${{env.DOC_NAME}}.pdf
